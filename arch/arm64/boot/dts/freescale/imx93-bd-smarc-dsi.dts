// SPDX-License-Identifier: (GPL-2.0-or-later OR MIT)
/*
 * Copyright 2022 NXP
 */

/dts-v1/;

#include "imx93-bd-smarc.dts"

#define DSI 8 // 10 = sn65, 8 = no sn65

/ {
	bd-variant = "i.MX93 SMARC Board DSI 8\"";

	dsi_backlight: dsi-backlight {
                brightness-levels = <0 1 2 3 4 5 6 7 8 9 10>;
                compatible = "pwm-backlight";
                default-brightness-level = <8>;
                display = <&lcdif>;
                pinctrl-names = "default";
                pinctrl-0 = <&pinctrl_backlight>;
                pwms = <&tpm5 3 30000 0>;       /* 42 = 24MHz  30000 = 3.3 Khz */
                status = "okay";
        };

	mipi_cmds_ltk080a60a004t: mipi-cmds-ltk080a60a004t {
		alias = <&mipi_cmds_ltk080a60a004t>;
		delay-prepare = <100>;
		delay-unprepare = <2>;
		mipi-cmds-enable = /bits/ 8 <0x40 2>; // DELAY(2)
		mipi-cmds-disable = /bits/ 8 <0x40 50>; // DELAY(50)
		min-hs-clock-multiple = <8>;
		mode-video-hfp-disable;
		mode-video-hsa-disable;
	};

	mipi_cmds_m101nwwb: mipi-cmds-m101nwwb {
                alias = <&mipi_cmds_m101nwwb>;
                mode-video-hbp-disable;
                mode-video-hfp-disable;
                mode-video-hsa-disable;
        };
};

&i2cmuxlcdc {
	/* 0x5d or 0x14 */
	ts_goodix: touchscreen@14 {
                compatible = "goodix,gt9271";
                esd-recovery-timeout-ms = <2000>;
		interrupts-extended = <&pcal6534 16 IRQ_TYPE_EDGE_RISING>;
		interrupt-parent = <&pcal6534>;
                interrupts = <16 IRQ_TYPE_EDGE_RISING>;
                irq-gpios = <&pcal6534 16 GPIO_ACTIVE_HIGH>;
                pinctrl-names = "default";
                pinctrl-0 = <&pinctrl_ts_dsi_gt911>;
                reg = <0x14>;
                reset-gpios = <&gpio2 3 GPIO_ACTIVE_HIGH>;
                status = "okay";
        };
#if 0
	ts_lvds_ft5x06: touchscreen@38 {
                //compatible = "edt,ft5x06-ts";
                compatible = "edt,ft7250";
		interrupt-parent = <&pcal6534>;
                interrupts = <16 IRQ_TYPE_EDGE_FALLING>;
                pinctrl-names = "default";
                pinctrl-0 = <&pinctrl_ts_dsi_gt911>;
                reg = <0x38>;
                reset-gpios = <&gpio2 3 GPIO_ACTIVE_LOW>;
                wakeup-gpios = <&pcal6534 16 GPIO_ACTIVE_LOW>;
                status = "okay";
        };

	dsi0_sn65dsi84: dsi0@2c {
                compatible = "ti,sn65dsi84";
                enable-gpios = <&pcal6534 17 GPIO_ACTIVE_HIGH>;
                reg = <0x2c>;
                status = "okay";
        };
#endif
};

&tpm5 {
	status = "okay";
};

&media_blk_ctrl {
        status = "okay";
};

&dphy {
        status = "okay";
};

&dsi {
	status = "okay";

        fb_mipi: panel@0 {
                backlight = <&dsi_backlight>;
                bits-per-color = <8>;
                bridge-de-active = <0>;
                bus-format = "rgb888";
                clocks = <&clk IMX93_CLK_MIPI_TEST_BYTE>,
                        <&clk IMX93_CLK_MEDIA_DISP_PIX>;
                clock-names = "mipi_clk", "pixel_clock";
                compatible = "panel,common";
                dsi-format = "rgb888";
                dsi-lanes = <4>;

		/* This tends to be done by Boundarys U-boot */
#if DSI == 10
		mipi-cmds = <&mipi_cmds_m101nwwb>;
#else
		mipi-cmds = <&mipi_cmds_ltk080a60a004t>;
#endif

                mode-skip-eot;
                mode-video;
                mode-video-burst;
                panel-height-mm = <136>;
                panel-width-mm = <217>;

		/* used by dsi_to_lvds node ?? !!! */
//		pinctrl-names = "sn65dsi83";
//		pinctrl-0 = <&pinctrl_i2cmuxlcdc_sn65dsi83>;

                power-supply = <&reg_vref_5v0>;
                reg = <0>;
                spwg;

#if DSI == 10
                sn65dsi83 = <&dsi_to_lvds>;
#endif

                display-timings {
#if DSI == 10
                        t_dsi: t-dsi-default {
                                /* m101nwwb by default */
                                clock-frequency = <66000000>;
                                hactive = <1280>;
                                vactive = <800>;
                                hback-porch = <5>;
                                hfront-porch = <123>;
                                vback-porch = <3>;
                                vfront-porch = <24>;
                                hsync-len = <1>;
                                vsync-len = <1>;
                                hsync-active = <0>;
                                vsync-active = <0>;
                                de-active = <1>;
                        };
#else
			t_dsi: t-dsi-default {
				/* ltk080a60a004t */
				clock-frequency = <120000000>;
				hactive = <1200>;
				vactive = <1920>;
				hback-porch = <60>;
				vback-porch = <25>;
				hfront-porch = <42>;
				vfront-porch = <35>;
				hsync-len = <2>;
				vsync-len = <1>;
                                hsync-active = <0>;
                                vsync-active = <0>;
			};
#endif
		};
#if DSI == 10
		dsi_to_lvds: dsi-to-lvds {
                        enable-gpios = <&pcal6534 17 GPIO_ACTIVE_HIGH>;
                        i2c-address = <0x2c>;
                        i2c-bus = <&i2cmuxlcdc>;
                        interrupts-extended = <&pcal6534 18 (IRQ_TYPE_EDGE_RISING | GPIO_PULL_DOWN)>;
                        status = "okay";
                };
#endif

		port {
                        panel_in: endpoint {
                                remote-endpoint = <&dsi_out>;
                        };
                };
	};

	ports {
                port@1 {
                        reg = <1>;

                        dsi_out: endpoint {
                                remote-endpoint = <&panel_in>;
                        };
                };
        };
};

&lcdif {
        assigned-clock-rates = <484000000>, <121000000>, <400000000>, <133333333>;
	status = "okay";
};

&iomuxc {

	pinctrl_backlight: backlight {
		fsl,pins = <
			MX93_PAD_GPIO_IO26__TPM5_CH3				0x02
		>;
	};

	pinctrl_ts_dsi_gt911: tsdsigt911grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO03__GPIO2_IO03			0x31e
		>;
	};
};
